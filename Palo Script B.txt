#######
# Palo Alto:
# Outside – 172.16.101.254/24
# Inside – 172.20.242.254/24
# Management GUI – 172.20.242.150
#######
# Subnet: 172.20.242.0/24 --- 172.25.<team>.0/24
# Ecom – 172.20.242.30 --- 172.25.<team>.<host>
# Webmail – 172.20.242.40 --- 172.25.<team>.<host>
# Splunk – 172.20.242.20 --- 172.25.<team>.<host>
# Ubuntu Wkst – DHCP
#######

#######
# Device & MGMT Hardening
set deviceconfig system permitted-ip 172.20.242.0/24 ---- UbuntuWkst IP 
set deviceconfig system login-banner AuthorizedAccessOnly

# Interface Management Profile
set network profiles interface-management-profile Default ping no https yes ssh yes telnet no http no snmp no response-pages no
set network profiles interface-management-profile Default permitted-ip 172.20.242.0/24

# MGMT Profile to Interfaces
set network interface ethernet ethernet1/1 layer3 interface-management-profile Default
set network interface ethernet ethernet1/2 layer3 interface-management-profile Default
#######

#######
# Security Profiles
set profile-group SecPro file-blocking "strict file blocking" spyware default url-filtering default virus default vulnerability default wildfire-analysis default
#######

#######
# Zone Protection
set network profiles zone-protection-profile ZonePro discard-tcp-synack-with-data yes
set network profiles zone-protection-profile ZonePro discard-timestamp yes
set network profiles zone-protection-profile ZonePro discard-unknown-option yes
set network profiles zone-protection-profile ZonePro remove-tcp-timestamp yes
set network profiles zone-protection-profile ZonePro strict-ip-check yes
set network profiles zone-protection-profile ZonePro strip-mptcp-option yes
set network profiles zone-protection-profile ZonePro strip-tcp-fast-open-and-data yes
set network profiles zone-protection-profile ZonePro suppress-icmp-needfrag yes
set network profiles zone-protection-profile ZonePro suppress-icmp-timeexceeded yes
set network profiles zone-protection-profile ZonePro tcp-reject-non-syn yes

set network profiles zone-protection-profile ZonePro flood tcp-syn enable yes red activate-rate 10000 alarm-rate 10000 maximal-rate 10000
set network profiles zone-protection-profile ZonePro flood udp enable yes red activate-rate 10000 alarm-rate 10000 maximal-rate 10000
set network profiles zone-protection-profile ZonePro flood icmp enable yes red activate-rate 10000 alarm-rate 10000 maximal-rate 10000
set network profiles zone-protection-profile ZonePro flood other-ip enable yes red activate-rate 10000 alarm-rate 10000 maximal-rate 10000
set network profiles zone-protection-profile ZonePro flood icmpv6 enable yes red alarm-rate 1000 activate-rate 2000 maximal-rate 3000
#######

#######
# Attach Profile to Zones
set zone VyOS network zone-protection-profile ZonePro
set zone Inside26 network zone-protection-profile ZonePro
#######

#######
# Services for Splunk Ingest 
set service Splunk-1514-tcp protocol tcp port 1514
set service Splunk-1514-udp protocol udp port 1514
set service-group Splunk-1514-both members [ Splunk-1514-tcp Splunk-1514-udp ]
set service Splunk-9998 protocol tcp port 9998
#######

#######
# OBJECTS (optional)
# Address objects
# Internal servers
set address ecom ip-netmask 172.20.242.104/32
set address splunk ip-netmask 172.20.242.20/32
set address webmail ip-netmask 172.20.242.101/32
# Public servers 
set address ecom-public ip-netmask 172.25.39.11/32
set address webmail-public ip-netmask 172.25.39.39/32
set address splunk-public ip-netmask 172.25.39.9/32
# Inside and Outside
set address linux-inside ip-netmask 172.20.242.0/24
set address outside ip-netmask 172.16.101.0/24
set address Public IPs ip-netmask 172.25.39.0/24
# Optional Objects for clarity
set address cisco-net-240 ip-netmask 172.20.240.0/24
set address UbuntuWkst-Admin ip-netmask 172.20.242.xx
set address vyos-net1 ip-netmask 172.16.101.1/32
set address palo-outside ip-netmask 172.16.101.240/32
set address vyos-external ip-netmask 172.31.21.2/32
set address vyos-external-net ip-netmask 172.31.21.0/29
set address palo-mgmt ip-netmask 172.20.242.150/32

# Address groups (optional) #
set address-group public-servers static [ ecom-public splunk-public webmail-public ]
set address-group internal-servers static [ ecom splunk webmail ]
#######

#######
# Security Rules

# Inbound Rules #
# Inbound ICMP
set rulebase security rules Allow-ICMP-Inbound profile-setting group SecPro
set rulebase security rules Allow-ICMP-Inbound from VyOS to Inside26 source any destination any \
application ping service application-default action allow log-start yes log-end yes

# Ecom Inbound
set rulebase security rules Allow-Ecom-Inbound profile-setting group SecPro
set rulebase security rules Allow-Ecom-Inbound from VyOS to Inside26 source any destination ecom \
application [ ssl web-browsing ] service application-default action allow log-start yes log-end yes

# Webmail Inbound
set rulebase security rules Allow-Webmail-Inbound profile-setting group SecPro
set rulebase security rules Allow-Webmail-Inbound from VyOS to Inside26 source any destination webmail \
application [ ssl web-browsing smtp pop3 imap ] service application-default action allow log-start yes log-end yes

# Splunk Inbound
set rulebase security rules Allow-Splunk-Inbound profile-setting group SecPro
set rulebase security rules Allow-Splunk-Inbound from VyOS to Inside26 source any destination splunk \
application [ splunk ssl web-browsing ] service application-default action allow log-start yes log-end yes

# Inbound Deny (Perimeter)
set rulebase security rules Inbound-Deny-All from VyOS to Inside26 source any destination any \
application any service any action deny log-start yes log-end yes

# Internal East/West Traffic #
# Splunk Ingest
set rulebase security rules Allow-Splunk-Ingest profile-setting group SecPro
set rulebase security rules Allow-Splunk-Ingest from Inside26 to Inside26 \
source [ webmail ecom palo-mgmt ] destination splunk application any \
service [ Splunk-1514-both Splunk-9998 ] action allow log-start yes log-end yes

# Deny server to server (Lateral)
set rulebase security rules Deny-Server-Lateral from Inside26 to Inside26 \
source linux-inside destination linux-inside \
application any service any action deny log-start yes log-end yes

# Outbound Rules #
# DNS outbound
set rulebase security rules Allow-DNS-Outbound profile-setting group SecPro
set rulebase security rules Allow-DNS-Outbound from Inside26 to VyOS source linux-inside destination any \
application dns service application-default action allow log-start yes log-end yes

# Core outbound
set rulebase security rules Allow-Core-Web-Outbound profile-setting group SecPro
set rulebase security rules Allow-Core-Web-Outbound from Inside26 to VyOS source linux-inside destination any \
application [ ssl web-browsing ] service application-default action allow log-start yes log-end yes

# NTP outbound
set rulebase security rules Allow-NTP-Outbound profile-setting group SecPro
set rulebase security rules Allow-NTP-Outbound from Inside26 to VyOS source linux-inside destination any \
application ntp service application-default action allow log-start yes log-end yes

# Webmail outbound
set rulebase security rules Allow-Webmail-Outbound profile-setting group SecPro
set rulebase security rules Allow-Webmail-Outbound from Inside26 to VyOS source webmail destination any \
application [ ssl web-browsing smtp pop3 imap ] service application-default action allow log-start yes log-end yes

# Palo & Wildfire updates
set rulebase security rules Allow-Palo-Updates profile-setting group SecPro
set rulebase security rules Allow-Palo-Updates from Inside26 to VyOS source palo-mgmt destination any \
application [ pan-db-cloud paloalto-updates paloalto-wildfire-cloud ] service application-default action allow log-start yes log-end yes

# Linux repos
set rulebase security rules Allow-Linux-Repos profile-setting group SecPro
set rulebase security rules Allow-Linux-Repos from Inside26 to VyOS source linux-inside destination any \
application [ github apt-get google-base yum ] service application-default action allow log-start yes log-end yes

# Outbound Deny (C2/reverse shells)
set rulebase security rules Outbound-Deny-All from Inside26 to VyOS source any destination any \
application any service any action deny log-start yes log-end yes

# Final Denies and Blocks #
# Block noisy protocols
set rulebase security rules BlockBad from any to any source any destination any \
application [ telnet ms-rdp vnc ftp tftp snmp ms-ds-smb rpc http-proxy ] \
service application-default action deny log-start yes log-end yes

# Deny All
set rulebase security rules Deny-All from any to any source any destination any \
application any service any action deny log-start yes log-end yes
#######

# content updates
request anti-virus upgrade install version latest
request wildfire upgrade install version latest
request content upgrade install version latest

commit

